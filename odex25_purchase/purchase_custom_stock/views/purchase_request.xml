<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <data>

        <record id="action_account_asset_assignment" model="ir.actions.act_window">
            <field name="name">Assets Assignment</field>
            <field name="res_model">account.asset.operation</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{'create': False }</field>
            <field name="domain">[('purchase_request_id', '=', active_id),('type', '=', 'assignment')]</field>
            <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('exp_asset_custody.view_account_asset_assignment_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('exp_asset_custody.view_account_asset_operation_form')})]"/>
        </record>

        <record id="action_account_asset_release" model="ir.actions.act_window">
            <field name="name">Assets Release</field>
            <field name="res_model">account.asset.operation</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{ 'create': False }</field>
            <field name="domain">[('purchase_request_id', '=', active_id),('type', '=', 'release')]</field>
            <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('exp_asset_custody.view_account_asset_release_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('exp_asset_custody.view_account_asset_operation_form')})]"/>
        </record>


        <!-- purchase.request form view -->
        <record id="purchase_request_form_inherit" model="ir.ui.view">
            <field name="name">purchase.request.view.form</field>
            <field name="model">purchase.request</field>
            <field name="inherit_id" ref="purchase_requisition_custom.purchase_request_form"/>
            <field name="arch" type="xml">
                <xpath expr="//div[@name='button_box']/button[@name='open_purchase']" position="after">
                    <button class="oe_stat_button" type="action"
                            groups="exp_asset_base.group_assets_manager,stock.group_stock_manager"
                            name="%(action_account_asset_assignment)d" icon="fa-pencil"
                            attrs="{'invisible':['|',('state' , 'not in' , ('done','employee','waiting','wait_for_send','initial')),('asset_assign_count','=',0)]}"
                    >
                        <field name="asset_assign_count" string="Assignments" widget="statinfo"/>
                    </button>
                    <button class="oe_stat_button" type="action"
                            groups="exp_asset_base.group_assets_manager,stock.group_stock_manager"
                            name="%(action_account_asset_release)d" icon="fa-pencil"
                            attrs="{'invisible':['|','|',('asset_release_count','=',0),('show_asset_release_button','=',False),('state', 'not in', ('done','employee','wait_for_send'))]}">
                        <field name="asset_release_count" string="Releases" widget="statinfo"/>
                    </button>
                </xpath>
                <xpath expr="/form/header/button[@name='action_done']" position="replace">
                    <button name="action_done" type="object" string="Delivery Done" class="oe_highlight"
                            groups="purchase_requisition_custom.create_purchase_request"
                            attrs="{'invisible':[('show_emp_button' , '=' , False)]}"/>
                </xpath>
                <xpath expr="//field[@name='use_analytic']" position="attributes">
                    <attribute name="attrs">{'readonly':[('state','!=','draft')]}</attribute>
                </xpath>
                <xpath expr="//group[1]" position="after">
                    <group col="2" colspan="2">
                        <field name="view_location_id" invisible="1"/>
                        <field name="edit_locations" invisible="1"/>
                        <field name="show_emp_button" invisible="1"/>
                        <field name="show_approve_warehouse" invisible="0"/>
                        <field name="has_asset_product_line" invisible="1"/>
                        <field name="show_asset_release_button" invisible="1"/>
                        <field name="all_assets_released" invisible="1"/>
                        <field name="asset_custody_complete" invisible="1"/>
                        <div>
                            <label for="warehouse_id"/>
                            <field name="warehouse_id"
                                   attrs="{'readonly':['|',('edit_locations' , '=' , False),('state' , '!=' , 'warehouse')]}"
                                   groups="stock.group_stock_user,stock.group_stock_manager"/>

                        </div>
                        <div>
                            <label for="location_id"/>
                            <field name="location_id"
                                   attrs="{'readonly':['|',('edit_locations' , '=' , False),('state' , '!=' , 'warehouse')]}"
                                   groups="stock.group_stock_user,stock.group_stock_manager"/>

                        </div>
                    </group>
                </xpath>
                <xpath expr="//button[@name='open_requisition']" position="after">
                    <field name="picking_id" invisible="1"/>
                    <button class="oe_stat_button" name="open_picking" type="object"
                            string="Delivery" icon="fa-list-ol"
                            attrs="{'invisible' : [('picking_id' , '=' ,False)]}"
                            groups="stock.group_stock_user,stock.group_stock_manager"/>
                </xpath>

                <xpath expr="//button[@name='action_confirm']" position="after">
                    <button name="action_confirm_picking"
                            type="object" string="Confirm"
                            attrs="{'invisible':[('show_approve_warehouse' , '=' , False)]}" class="oe_highlight"
                            groups="stock.group_stock_user,stock.group_stock_manager"/>
                    <button name="action_available_qty"
                            type="object" string="Available Quantity"
                            attrs="{'invisible':[('show_approve_warehouse' , '=' , False)]}" class="oe_highlight"
                            groups="stock.group_stock_user,stock.group_stock_manager"/>
                    <button name="action_refuse" type="object" string="Refuse" id="prs_request_refuse"
                            groups="stock.group_stock_manager"
                            attrs="{'invisible' : [('state' , '!=' , 'warehouse')]}"/>
                </xpath>
                <xpath expr="//button[@name='action_draft']" position="before">
                    <button name="create_asset_custody_lines"
                            type="object"
                            string="Create Asset Custody"
                            class="oe_highlight"
                            groups="exp_asset_base.group_assets_manager"
                            attrs="{'invisible': ['|','|',('state' , 'not in' , ('done','employee','waiting','wait_for_send','initial')),('has_asset_product_line', '=', False),('asset_custody_complete', '=', True)]}"/>
                    <button name="return_account_asset_operation"
                            type="object" string="Return Done"
                            attrs="{'invisible':['|','|','|',('state', 'not in', ('done','employee','wait_for_send')),('asset_release_count','=',0),('show_asset_release_button','=',False),('all_assets_released','=',True)]}"
                            class="oe_highlight"
                            groups="exp_asset_base.group_assets_manager"/>
                </xpath>
                <xpath expr="//field[@name='line_ids']/tree[1]/field[@name='qty']" position="after">
                    <field name="available_qty" readonly="1"
                           attrs="{'column_invisible': [('parent.state', '!=', 'warehouse')]}"/>
                    <field name="qty_purchased" readonly="1"
                           attrs="{'column_invisible': [('parent.state', '!=', 'waiting')]}"/>
                </xpath>

                <xpath expr="//notebook/page" position="after">
                    <page string="Asset Lines"
                          attrs="{'invisible':['|',('has_asset_product_line','=',False),('state','in',('draft','direct_manager'))]}"
                          groups="stock.group_stock_manager">
                        <field name="asset_request_line_ids" nolabel="1"
                               attrs="{'readonly': [ ('state', 'not in', ('warehouse'))]}">
                            <tree string="Asset Lines" editable="top">
                                <field name="asset_id" required="1"
                                       domain="[('status', 'in',{'assignment': ['available']}.get(type, ['new', 'available'])),('asset_type', '=', 'purchase')]"/>
                                <field name="custody_type" attrs="{'required': [('type', '=', 'assignment')]}"/>
                                <field name="custody_period"
                                       attrs="{'required': [('type', '=', 'assignment')]}"/>
                                <field name="return_date" attrs="{'required': [('custody_period', '=', 'temporary')],
                                                    'invisible': [('custody_period', '!=', 'temporary')],
                                                    'readonly': [ ('custody_period', '!=', 'temporary')]}"/>
                                <field name="type" invisible="1"/>
                            </tree>
                        </field>
                    </page>
                </xpath>
            </field>
        </record>

        <!-- purchase.request tree view -->


    </data>
</odoo>
